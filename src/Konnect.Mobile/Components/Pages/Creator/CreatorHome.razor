@page "/creator/home"
@inject IApiService ApiService
@inject NavigationManager Navigation

<div class="header">
    <h1 class="header-title">Dashboard</h1>
</div>

<div class="page-content">
    <!-- Stats Overview -->
    <div class="card stats-card">
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-value">@_stats.ActiveDeals</span>
                <span class="stat-label">Active Deals</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">Rs @_stats.TotalEarnings</span>
                <span class="stat-label">Earnings</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">@_stats.CompletedDeals</span>
                <span class="stat-label">Completed</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="action-btn" @onclick='() => Navigation.NavigateTo("/creator/campaigns")'>
            <div class="action-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
            </div>
            <span>Find Campaigns</span>
        </button>
        <button class="action-btn" @onclick='() => Navigation.NavigateTo("/profile")'>
            <div class="action-icon secondary">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
            </div>
            <span>Edit Profile</span>
        </button>
    </div>

    <!-- Active Deals -->
    <h2 class="section-title">Active Deals</h2>
    @if (_activeDeals.Any())
    {
        @foreach (var deal in _activeDeals)
        {
            <div class="card deal-card" @onclick="() => ViewDeal(deal.Id)">
                <div class="deal-header">
                    <h3>@deal.Campaign?.Title</h3>
                    <span class="tag @GetStatusClass(deal.Status)">@deal.Status</span>
                </div>
                <p class="deal-business">@deal.Business?.FullName</p>
                <div class="deal-footer">
                    <span class="deal-price">Rs @deal.AgreedPrice</span>
                    <span class="deal-date">@deal.CreatedAt.ToString("MMM dd")</span>
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <p>No active deals yet</p>
            <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/creator/campaigns")'>
                Browse Campaigns
            </button>
        </div>
    }
</div>

<style>
    .stats-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .stats-card .stat-value { color: white; }
    .stats-card .stat-label { color: rgba(255,255,255,0.8); }
    
    .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0; }
    
    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 20px;
        background: white;
        border: none;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        cursor: pointer;
    }
    
    .action-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-icon.secondary { background: var(--secondary); }
    
    .section-title { font-size: 18px; font-weight: 600; margin: 24px 0 12px; }
    
    .deal-card { cursor: pointer; }
    .deal-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
    .deal-header h3 { font-size: 16px; flex: 1; }
    .deal-business { color: var(--text-secondary); font-size: 14px; margin-bottom: 12px; }
    .deal-footer { display: flex; justify-content: space-between; color: var(--text-muted); font-size: 14px; }
    .deal-price { font-weight: 600; color: var(--secondary); }
    
    .tag.pending { background: var(--warning); }
    .tag.inprogress { background: var(--primary); }
    .tag.completed { background: var(--success); }
</style>

@code {
    private DashboardStats _stats = new();
    private List<DealDto> _activeDeals = new();

    protected override async Task OnInitializedAsync()
    {
        var dealsResult = await ApiService.GetMyDealsAsync();
        if (dealsResult.Success && dealsResult.Data != null)
        {
            _activeDeals = dealsResult.Data
                .Where(d => d.Status != DealStatus.Completed && d.Status != DealStatus.Cancelled)
                .ToList();
            
            _stats.ActiveDeals = _activeDeals.Count;
            _stats.CompletedDeals = dealsResult.Data.Count(d => d.Status == DealStatus.Completed);
            _stats.TotalEarnings = dealsResult.Data
                .Where(d => d.Status == DealStatus.Completed)
                .Sum(d => d.AgreedPrice);
        }
    }

    private void ViewDeal(Guid dealId)
    {
        Navigation.NavigateTo($"/deals/{dealId}");
    }

    private static string GetStatusClass(DealStatus status) => status switch
    {
        DealStatus.Pending => "pending",
        DealStatus.InProgress or DealStatus.ContentSubmitted => "inprogress",
        DealStatus.Completed => "completed",
        _ => ""
    };

    private class DashboardStats
    {
        public int ActiveDeals { get; set; }
        public int CompletedDeals { get; set; }
        public decimal TotalEarnings { get; set; }
    }
}
