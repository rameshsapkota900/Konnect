@page "/business/creators"
@using Konnect.Mobile.Services
@using Konnect.Shared.DTOs
@using Konnect.Shared.Enums
@inject IApiService ApiService
@inject NavigationManager Navigation

<div class="header">
    <h1 class="header-title">Find Creators</h1>
    <button class="header-action" @onclick="ToggleFilters">
        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></svg>
    </button>
</div>

<div class="page-content">
    @if (_showFilters)
    {
        <div class="filter-panel">
            <div class="filter-row">
                <label>Min Followers</label>
                <input type="number" class="form-input" @bind="_filter.MinFollowers" placeholder="0" />
            </div>
            <div class="filter-row">
                <label>Max Rate (Rs./hr)</label>
                <input type="number" class="form-input" @bind="_filter.MaxRate" placeholder="Any" />
            </div>
            <div class="filter-row">
                <label>Location</label>
                <input type="text" class="form-input" @bind="_filter.Location" placeholder="e.g. Kathmandu" />
            </div>
            <button class="btn btn-primary btn-full" @onclick="ApplyFilters">Apply Filters</button>
        </div>
    }

    <div class="filter-chips">
        <button class="chip @(_selectedNiche == null ? "active" : "")" @onclick="() => FilterByNiche(null)">All</button>
        @foreach (var niche in _niches)
        {
            <button class="chip @(_selectedNiche == niche ? "active" : "")" @onclick="() => FilterByNiche(niche)">
                @niche.ToString()
            </button>
        }
    </div>

    @if (_isLoading)
    {
        <div class="loading">Loading creators...</div>
    }
    else if (_creators.Any())
    {
        @foreach (var creator in _creators)
        {
            <div class="creator-card" @onclick="() => ViewCreator(creator.UserId)">
                <div class="creator-header">
                    <div class="avatar large">@creator.User?.FullName?.FirstOrDefault()</div>
                    <div class="creator-info">
                        <h3 class="creator-name">@creator.User?.FullName</h3>
                        <p class="creator-location">@creator.User?.Location</p>
                        @if (creator.IsVerified)
                        {
                            <span class="verified-badge">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                Verified
                            </span>
                        }
                    </div>
                </div>
                
                <p class="creator-bio">@TruncateText(creator.Bio, 100)</p>
                
                <div class="creator-stats">
                    <div class="stat">
                        <span class="stat-value">@FormatFollowers(creator.FollowersCount)</span>
                        <span class="stat-label">Followers</span>
                    </div>
                    @if (creator.EngagementRate.HasValue)
                    {
                        <div class="stat">
                            <span class="stat-value">@creator.EngagementRate.Value.ToString("F1")%</span>
                            <span class="stat-label">Engagement</span>
                        </div>
                    }
                    @if (creator.HourlyRate.HasValue)
                    {
                        <div class="stat">
                            <span class="stat-value">Rs. @creator.HourlyRate.Value.ToString("N0")</span>
                            <span class="stat-label">Per Hour</span>
                        </div>
                    }
                </div>
                
                <div class="creator-niches">
                    @foreach (var niche in creator.Niches?.Take(3) ?? Enumerable.Empty<Niche>())
                    {
                        <span class="niche-tag">@niche</span>
                    }
                </div>
                
                <div class="creator-socials">
                    @if (!string.IsNullOrEmpty(creator.InstagramUrl))
                    {
                        <span class="social-icon instagram"></span>
                    }
                    @if (!string.IsNullOrEmpty(creator.TikTokUrl))
                    {
                        <span class="social-icon tiktok"></span>
                    }
                    @if (!string.IsNullOrEmpty(creator.YouTubeUrl))
                    {
                        <span class="social-icon youtube"></span>
                    }
                </div>
            </div>
        }
        
        @if (_hasMore)
        {
            <button class="btn btn-outline btn-full" @onclick="LoadMore">Load More</button>
        }
    }
    else
    {
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor" width="64" height="64">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <p>No creators found</p>
            <p class="text-secondary">Try adjusting your filters</p>
        </div>
    }
</div>

<BottomNavigation UserType="UserType.Business" />

<style>
    .header { display: flex; justify-content: space-between; align-items: center; }
    .header-action { background: none; border: none; padding: 8px; cursor: pointer; color: var(--primary); }
    
    .filter-panel { background: white; border-radius: var(--radius); padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); }
    .filter-row { margin-bottom: 12px; }
    .filter-row label { display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; }
    
    .filter-chips { display: flex; gap: 8px; overflow-x: auto; padding: 0 0 16px; -webkit-overflow-scrolling: touch; }
    .chip { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: white; font-size: 14px; white-space: nowrap; cursor: pointer; }
    .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .creator-card { background: white; border-radius: var(--radius); padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow); cursor: pointer; }
    .creator-header { display: flex; gap: 12px; margin-bottom: 12px; }
    .avatar.large { width: 60px; height: 60px; font-size: 24px; }
    .creator-info { flex: 1; }
    .creator-name { font-size: 18px; font-weight: 600; margin: 0; }
    .creator-location { color: var(--text-secondary); font-size: 14px; margin: 4px 0; }
    .verified-badge { display: inline-flex; align-items: center; gap: 4px; color: var(--success); font-size: 12px; font-weight: 500; }
    
    .creator-bio { color: var(--text-secondary); font-size: 14px; margin: 0 0 12px 0; line-height: 1.4; }
    
    .creator-stats { display: flex; gap: 16px; padding: 12px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
    .stat { text-align: center; flex: 1; }
    .stat-value { display: block; font-weight: 700; font-size: 16px; color: var(--primary); }
    .stat-label { font-size: 12px; color: var(--text-secondary); }
    
    .creator-niches { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
    .niche-tag { background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 12px; }
    
    .creator-socials { display: flex; gap: 8px; margin-top: 12px; }
    .social-icon { width: 24px; height: 24px; border-radius: 50%; }
    .social-icon.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
    .social-icon.tiktok { background: #000; }
    .social-icon.youtube { background: #FF0000; }
    
    .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
</style>

@code {
    private List<CreatorProfileDto> _creators = new();
    private Niche? _selectedNiche;
    private bool _isLoading = true;
    private bool _showFilters;
    private bool _hasMore;
    private int _currentPage = 1;
    private CreatorFilterDto _filter = new() { PageSize = 10 };
    private readonly Niche[] _niches = Enum.GetValues<Niche>().Take(10).ToArray();

    protected override async Task OnInitializedAsync() => await LoadCreators();

    private async Task LoadCreators()
    {
        _isLoading = true;
        _currentPage = 1;
        _filter.Niche = _selectedNiche;
        _filter.Page = _currentPage;
        
        var result = await ApiService.SearchCreatorsAsync(_filter);
        if (result.Success && result.Data != null)
        {
            _creators = result.Data.Items?.ToList() ?? new();
            _hasMore = result.Data.HasNextPage;
        }
        _isLoading = false;
    }

    private async Task LoadMore()
    {
        _currentPage++;
        _filter.Page = _currentPage;
        var result = await ApiService.SearchCreatorsAsync(_filter);
        if (result.Success && result.Data != null)
        {
            _creators.AddRange(result.Data.Items ?? new List<CreatorProfileDto>());
            _hasMore = result.Data.HasNextPage;
        }
    }

    private void ToggleFilters() => _showFilters = !_showFilters;
    
    private async Task ApplyFilters()
    {
        _showFilters = false;
        await LoadCreators();
    }

    private async Task FilterByNiche(Niche? niche)
    {
        _selectedNiche = niche;
        await LoadCreators();
    }

    private void ViewCreator(Guid userId) => Navigation.NavigateTo($"/creator/{userId}");

    private static string TruncateText(string? text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return text.Length <= maxLength ? text : text[..maxLength] + "...";
    }

    private static string FormatFollowers(int count) => count switch
    {
        >= 1000000 => $"{count / 1000000.0:F1}M",
        >= 1000 => $"{count / 1000.0:F1}K",
        _ => count.ToString()
    };
}
